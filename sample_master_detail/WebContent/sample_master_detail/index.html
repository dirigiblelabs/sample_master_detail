<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Business Object</title>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.css">
<link rel="stylesheet" href="css/xeditable.css">

<link rel="stylesheet" href="css/default.css">
<link rel="stylesheet" media="min-device-width: 800px" href="css/default.css" />
<!-- TODO: add stylesheets for different device sizes with coressponding media queries-->

</head>

<body ng-app="businessObjects">

	<div class="container-fluid">
		
		<div class="row-fluid page">
		
			<header class="page-title"><h1 class="h2">Business Objects Explorer</h1></header>
			
			<div class="page-content">
				<div ui-view="master" ng-show="items.length" class="master col-xs-12 col-md-2 no-gutter-left"></div>
				<div ui-view="detail"></div>
			</div>
			<div ui-view="notifications" class="notification-bar"></div>
			
		</div>
		
	</div>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>	
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.js"></script>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.3.1/angular-ui-router.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/1.3.3/ui-bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/1.3.3/ui-bootstrap-tpls.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-resource.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-animate.min.js"></script>
			
	<script src="js/xeditable.js"></script>	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.15.0/jquery.validate.min.js"></script>
	
	<script>
	angular.module('businessObjects', ['ngAnimate', 'ngResource', 'ui.router', 'ui.bootstrap', 'xeditable'])
	.config(['$stateProvider', '$urlRouterProvider', function($stateProvider, $urlRouterProvider) {
				
		$urlRouterProvider.otherwise("/");
		
		$stateProvider		
		.state('items', {
			  url: "/",
		      params: {
		    	  message: undefined  
		      },
		      resolve: {
		            entities: ['masterDataSvc',
		                function(masterDataSvc) {
		                	return masterDataSvc.query(true);
		            	}]		            	
		      },
		      views: {
		          'master': {
		              templateUrl: 'views/master-list.html',
		              controller: 'MasterListCtrl'
		          },
		          'detail': {
		              templateUrl: 'views/empty.html',
		              controller: 'EmptyCtrl'
		          },
		          'notifications': {
		              templateUrl: 'views/notifications.html',
		              controller: 'NotificationsCtrl'
		          }
		      }
		    })
		.state('items.select', {
			url: ":boId",
		    params: {
			  	selectedItem: undefined
		    }, 
			resolve: { 
	            selectedItem: ['$stateParams',
	                function($stateParams) {
	                	return $stateParams.selectedItem;
                }]
            },
            views: {
		    	  'detail@': {
					  templateUrl: "views/detail_view.html",
					  controller: 'DetailsCtrl'
			      }
		     }
		   })
		.state('items.select.edit', {
			  url: "edit",
		      params: {
		    	  items: undefined,
		    	  selectedItem: undefined,
		    	  itemForEdit: undefined,
		    	  message: {value: undefined}  
		      },
		      views: {
		          'master@': {
		              templateUrl: 'views/none.html'
		          },
			      'detail@': {
					  templateUrl: "views/detail_editor.html",
					  controller: 'EditCtrl'
			      }
		      }
		    })
		.state("items.select.edit.property", {
			url: "propertyAdd",
		    params: {
				selectedItem: undefined,
				item: undefined,
				message: {value: undefined}
		    },
		    onEnter: ['$stateParams', '$state', '$uibModal', function($stateParams, $state, $modal) {
		    	
		    	function goBack(_selectedItem) {
		        	$state.go("items.select.edit", {selectedItem: _selectedItem}, {location:false});
		        }
		    	
		        var modalInstance = $modal.open({
		        	animation: true,
		            templateUrl: "views/propertyEditor.html",
		            resolve: {
		            	selectedItem: function() { 
		            		return $stateParams.selectedItem; 
		            	}
		            },
		            controller: 'PropertyEditorCtrl'
		        });
		        modalInstance.rendered.then(function(){
		        	var $validator = $('.modal-body form').validate({
		        		errorClass: 'has-error',
		        		validClass : 'has-success',
 		        		highlight: function (element, errorClass, validClass) {
				            $(element).closest('.form-group').removeClass('has-success').addClass('has-error');
				            if($validator.numberOfInvalids()>0)
				            	$('.modal-footer .btn.btn-success').addClass('disabled');
				        },
				        unhighlight: function(element, errorClass, validClass) {
				        	$(element).closest('.form-group').removeClass('has-error').addClass('has-success');
				        	if($validator.numberOfInvalids()<1)
					        	$('.modal-footer .btn.btn-success').removeClass('disabled');	
				        },
		 		        success: "has-success"
		        	});
		        	$('.form-control[required]').each(function(i){
		        		$validator.element(this);
		        	});
		        });
		        modalInstance.result.then(goBack, goBack);
		    }]
		  });	
	}])
	.service('ResourceSvcConfiguration', function() {
	
		return {
			cfg: {
			    save: {
			        method: 'POST',
			        interceptor: {
		                response: function(res) {
		                	var location = res.headers('Location');
		                	if(location){
		                		var id = location.substring(location.lastIndexOf('/')+1);
		                		angular.extend(res.resource, { "mdh_id": id });
	                		} else {
	                			console.error('Cannot infer id after save operation. HTTP Response Header "Location" is missing: ' + location);
	            			}
	                        return res.resource;
		                }
		            }, 
		            isArray: false
			    },
			    update: {
			        method: 'PUT'
			    }
		    }
		}
	})
	.service('Entity', ['$resource', 'ResourceSvcConfiguration', function($resource, ResourceSvcConfiguration) {
	  	var res = $resource('../../js/sample_master_detail/md_header.js/:boId', { boId:'@id' }, ResourceSvcConfiguration.cfg);
		
		res.newObjectTemplate = {
				"mdh_name":"Business Object Name",
				"mdh_description":"Description for business object"
			};
			
		return res;
	}])
	.service('Item', ['$resource', 'ResourceSvcConfiguration', function($resource, ResourceSvcConfiguration) {
	
	  	var res = $resource('../../js/sample_master_detail/md_item.js/:boId', { boId:'@id' }, ResourceSvcConfiguration.cfg);
		
		
		res.newObjectTemplate = {
					"mdi_name":"Item",
					"mdi_description":"Description for Item"
				};
				
		return res;
	}])	
	.service('masterDataSvc', ['Entity', 'Item',  '$q', function(Entity, Item, $q) {
	
		function createMasterDataTemplateObject(){
			var obj = angular.copy(Entity.newObjectTemplate);
			obj.items = [];
			for(var i = 0; i < 3; i++){
				var item = angular.copy(Item.newObjectTemplate);
				item.mdi_name += ' ' +i;
				obj.items.push(item);
			}
			return obj;
		}
		
		this.masterDataTemplateObject = createMasterDataTemplateObject();
	
		this.query = function(expanded){
			var reqParams = {};
			reqParams.expanded = expanded || true;
			return Entity.query(reqParams).$promise;
		};

		this.create = function(cascaded){
			var reqParams = {};
			reqParams.cascaded = cascaded || true;
			return Entity.save(reqParams, this.masterDataTemplateObject).$promise;
		};
		
		this.update = function(header){
			if(header.items){
				var items = header.items.filter(function(item){
					if(!item.action){
						return false;
					}
					return true;
				});
				var promises = items.map(function(item) {
									var action = item.action;
									delete item.action;
									if(action === 'remove') {
							        	return Item.remove({boId: item.mdi_id}).$promise;
						        	} else {
						        		return Item[action]({boId: item.mdi_id}, item).$promise;
					        		}
						    	});
			}

			promises.unshift(Entity.update({boId: header.mdh_id}, header).$promise);
	    	return $q.all(promises);
		};	
		
		this.remove = function(headerId, cascaded){
			var reqParams = {};
			if(cascaded)
				reqParams.cascaded = cascaded;
			reqParams.boId = headerId;
			return Entity.remove(reqParams).$promise;
		};
		
		this.serviceErrorMessageFormatter = function(message, errorPayload){
			if(errorPayload.data.err.code){
				message += ': [' + errorPayload.data.err.code + '] ';
			}
			if(errorPayload.data.err.message){
				message += ' ' + errorPayload.data.err.message;
			}
			return message;
		};
		
	}])
	.controller('EmptyCtrl', ['masterDataSvc', '$scope', '$log', '$state', '$stateParams', function (masterDataSvc, $scope, $log, $state, $stateParams) {
	
		$scope.createItem = function(){
			masterDataSvc.create()
			.then(function(newItem){
				$stateParams.boId = newItem.mdh_id;
				$stateParams.message = {
					text: 'New Buisness Object successfully created.',
					type: 'alert-success'
				};
			}, function(reason){
				var message = masterDataSvc.serviceErrorMessageFormatter('Creating new Buisness Object failed', reason);
				$log.error(message);			
				$stateParams.message = {
						text: message,
						type: 'alert-danger'
				};
			})
			.finally(function(){
				$state.go($state.current, $stateParams, {reload: true});
			});
		};
	
	}])
	.controller('MasterListCtrl', ['masterDataSvc', 'entities', '$scope', '$log', 'orderByFilter', '$state', '$stateParams', '$window', function (masterDataSvc, entities, $scope, $log, orderBy, $state, $stateParams, $window) {
		/*Controller invoked upon routing or navigation click events*/
		$scope.items = entities;
		
		$scope.sortByPropertyName = 'mdh_name';
	    $scope.reverse = false;//ASC
				
		this.$onInit = function(){
			var itemId = $state.params.boId;//requested item id
			if($scope.items.length >0) {

				$scope.sortBy($scope.sortByPropertyName);
				
				itemId = $state.params.boId || $scope.items[0].mdh_id;//in case no item id has been explicitly requested, preselect the id of the first one in the list
				var item = $scope.items.filter(function(item){
					if(item.mdh_id == itemId ){
						return true;
					}
					return false;
				})[0];
				if(item === undefined){
					fireLocationError.apply(this);
					item = $scope.items[0];
				}
				$scope.selectItem.apply($scope, [item]);//set the requested item selected
				
			} else {
				if(!!itemId){
					fireLocationError.apply($scope);
					$state.go('items', $stateParams);
				}
			}
		};
		
		function fireLocationError(){
			$log.debug('The requested application path ' + $window.location.href + " is not valid.");
			$stateParams.message = {
					text: $window.location.href + ' is not valid application path. Check the URL and try again.',
					type: 'alert-danger'
			};
		}
		
		$scope.sortBy = function(propertyName) {
		    $scope.reverse = (propertyName !== null && $scope.propertyName === propertyName)
		        ? !$scope.reverse : false;
		    $scope.sortByPropertyName = propertyName;
		    $scope.items = orderBy($scope.items, $scope.sortByPropertyName, $scope.reverse);
		};
		
		$scope.selectItem = function(item){
			$scope.selectedItem = item;// save the selected item
			$state.go('items.select', {
				selectedItem: item,
				boId: item.mdh_id
			});
		};
		
		$scope.createItem = function(){
			masterDataSvc.create()
			.then(function(newItem){
				$stateParams.boId = newItem.mdh_id;
				$stateParams.message = {
					text: 'New Buisness Object successfully created.',
					type: 'alert-success'
				};
			}, function(reason){
				handleServiceError('Creating new Buisness Object failed', reason);
			})
			.finally(function(){
				$state.go($state.current, $stateParams, {reload: true});
			});
		};
		
		$scope.deleteItem = function(itemId){
			masterDataSvc.remove(itemId)
			.then(function(){
				//$state.reload();
				delete $stateParams.boId;
				$stateParams.message = {
						text: 'Buisness Object successfully deleted.',
						type: 'alert-success'
					};
				$state.go($state.current, $stateParams, {reload: true, location:true, inherit: false});
			}, function(reason){
				handleServiceError('Deleting Buisness Object failed', reason);
				$state.go('^', $stateParams, {reload: true});
			});
		};
		
		function handleServiceError(text, errorPayload){
			var message = masterDataSvc.serviceErrorMessageFormatter(text, errorPayload);
			$log.error(message);			
			$stateParams.message = {
					text: message,
					type: 'alert-danger'
			};
		};
		
	}])
	.controller('DetailsCtrl', ['masterDataSvc', 'selectedItem', '$scope', '$log', '$state', '$stateParams' , function (masterDataSvc, selectedItem, $scope, $log, $state, $stateParams) {
		
		$scope.selectedItem = selectedItem;
		
		function handleServiceError(text, errorPayload){
			var message = masterDataSvc.serviceErrorMessageFormatter(text, errorPayload);
			$log.error(message);			
			$stateParams.message = {
					text: message,
					type: 'alert-danger'
			};	
		};
		
		$scope.startEdit = function() {
		    $stateParams.itemForEdit = angular.copy($scope.selectedItem);		    
		    $state.go("items.select.edit", $stateParams, {location:false});
		};
		
		$scope.duplicateItem = function() {
			var duplicateItem = angular.copy($scope.selectedItem, {});
			delete duplicateItem.mdh_id;
			masterDataSvc.create(duplicateItem)
				.then(function(newItem){
					$stateParams.boId = newItem.mdh_id;
					$state.go($state.current, $stateParams, {reload: true, location:true, inherit: true});
				}, function(reason){
					handleServiceError('Duplicating Buisness Object failed', reason);
					$state.go('^', $stateParams, {reload: true});
				});
		};
		
		$scope.deleteItem = function() {
			masterDataSvc.remove($scope.selectedItem.mdh_id)
			.then(function(){
				delete $stateParams.boId;
				$stateParams.message = {
						text: 'Buisness Object successfully deleted.',
						type: 'alert-success'
					};
				$state.go($state.current, $stateParams, {reload: true, location:true, inherit: false});
			}, function(reason){
					handleServiceError('Deleting Buisness Object failed', reason);
					$state.go('^', $stateParams, {reload: true});
				});
		};
		
	}])
	.controller('EditCtrl', ['masterDataSvc', '$scope', '$log', '$state', '$stateParams', function (masterDataSvc, $scope, $log, $state, $stateParams) {

		$scope.selectedItem = angular.copy($stateParams.itemForEdit);

		$scope.openPropertyEditor = function(item){
			$state.go('items.select.edit.property', {
				selectedItem: $scope.selectedItem,
				item: item
			}, {location: false});
		};
		
		$scope.deleteProperty = function(item){
			for(var i=0; i< $scope.selectedItem.items.length; i++){
				if($scope.selectedItem.items[i] === item){
					$scope.selectedItem.items.splice(i,1);
					break;
				}
			}
			$stateParams.itemForEdit.items = $stateParams.itemForEdit.items.map(
				function(currItem){
					if(currItem.mdi_id && currItem.mdi_id === item.mdi_id){
						currItem.action = 'remove';
					}
					return currItem;
				});
		};
		
		$scope.cancelEdit = function() { 
			delete $stateParams.boIdedit;
			delete $stateParams.itemForEdit;
		    $state.go("^", $stateParams);
		};
		
		$scope.saveItem = function() {
		    masterDataSvc.update($scope.selectedItem)
		    	.then(function(item){
					$state.go('^', {boId: $scope.selectedItem.mdh_id, selectedItem:$scope.selectedItem}, {reload: true, location:false});
		    	}, function(reason){
		    		var message = masterDataSvc.serviceErrorMessageFormatter('Updating Buisness Object failed', reason);
					$log.error(message);
					$stateParams.message = {
							text: message,
							type: 'alert-danger'
					}				
					$state.go($state.current, $stateParams, {reload: false});
				});
		};
				
	}])
	.controller('PropertyEditorCtrl', ['$scope', '$stateParams', 'selectedItem', function($scope, $stateParams, selectedItem) {
    	
		var isNewProperty;
		
		function init(){
			isNewProperty = $stateParams.item === undefined ? true : false;
			if(isNewProperty) {
				$scope.item = {
					mdi_name: "Item Name",
					mdi_mdh_id: $stateParams.selectedItem.mdh_id
				};
			} else {
				$scope.item = $stateParams.item;
			}
		}
        
        $scope.cancel = function() {
          $scope.$dismiss($stateParams.selectedItem);
        };

        $scope.ok = function() {
          
	      if(isNewProperty){
	      	$scope.item.action = 'save';
	      	selectedItem.items.push($scope.item);
	      	$stateParams.itemForEdit = $stateParams.selectedItem = selectedItem;
	      } else {
	      	$scope.item.action = 'update';
	    	selectedItem = $stateParams.itemForEdit = $stateParams.selectedItem; 
	      }
          $scope.$close(selectedItem);
        };
        
        init.apply(this);
        
      }])
	.controller('NotificationsCtrl', ['$scope', '$timeout', '$stateParams', function ($scope, $timeout, $stateParams) {
		
		var messageEl = $('.alert');
		$scope.message = $stateParams.message;
		
		$scope.hide = hideMessage;
		
		var timer;
		
		if($scope.message){
			
			$scope.messageTypeClass = $scope.message.type || 'alert-danger';
			
			timer = $timeout(5000)
				.then(function(){
					hideMessage.apply(this);
				});	
		}
		
		function hideMessage(element){
			if($scope.message){
				element = element || messageEl;
				$(element).fadeTo('slow', 0, function(){
					$(element).parent().slideUp('slow', function(){
						$scope.message = undefined;
						$timeout.cancel(timer);
						$scope.$apply();
					});
				});	
			}
		}

		$scope.destroy = function(){
			if(timer){
				$timeout.cancel(timer);
			}
		}
				
	}])
	.run(['editableOptions', function(editableOptions)  {
	  editableOptions.theme = 'bs3'; // bootstrap3 theme. Can be also 'bs2', 'default'
	}]);
	
	</script>

</body>
</html>
