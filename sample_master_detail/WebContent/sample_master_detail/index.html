<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Business Object</title>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.css">
<link rel="stylesheet" href="css/xeditable.css">

<link rel="stylesheet" href="css/default.css">
<link rel="stylesheet" media="min-device-width: 800px" href="css/default.css" />
<!-- TODO: add stylesheets for different device sizes with coressponding media queries-->

</head>

<body ng-app="businessObjects">

	<div class="container-fluid">
		
		<div class="row-fluid page">
		
			<header class="page-title"><h1 class="h2">Business Objects Explorer</h1></header>
			
			<div class="page-content">
				<div ui-view="master" ng-show="items" class="master col-xs-12 col-md-2 no-gutter-left"></div>
				<div ui-view="detail"></div>
			</div>
			<div ui-view="notifications" class="notification-bar"></div>
			
		</div>
		
	</div>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>	
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.js"></script>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.3.1/angular-ui-router.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/1.3.3/ui-bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/1.3.3/ui-bootstrap-tpls.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-resource.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular-animate.min.js"></script>
			
	<script src="js/xeditable.js"></script>	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.15.0/jquery.validate.min.js"></script>
	
	<script>
	angular.module('businessObjects', ['ngAnimate', 'ngResource', 'ui.router', 'ui.bootstrap', 'xeditable'])
	.config(['$stateProvider', '$urlRouterProvider', function($stateProvider, $urlRouterProvider) {
				
		$urlRouterProvider.otherwise("/");
		
		$stateProvider		
		.state('items', {
			  url: "/",
		      params: {
		    	  message: undefined  
		      },
		      views: {
		          'master': {
		              templateUrl: 'views/master-list.html',
		              controller: 'MasterListCtrl'
		          },
		          'detail': {
		              templateUrl: 'views/empty.html',
		              controller: 'EmptyCtrl'
		          },
		          'notifications': {
		              templateUrl: 'views/notifications.html',
		              controller: 'NotificationsCtrl'
		          }
		      }
		    })
		.state('items.select', {
			  url: ":boId",
		      params: {
		    	  items: undefined,
				  selectedItem: undefined
		      },
		      views: {
		    	  'detail@': {
					  templateUrl: "views/detail_view.html",
					  controller: 'DetailsCtrl'
			      }
		      }
		    })
		.state('items.select.edit', {
			  url: "edit",
		      params: {
		    	  items: undefined,
		    	  selectedItem: undefined,
		    	  itemForEdit: undefined,
		    	  message: {value: undefined}  
		      },
		      views: {
		          'master@': {
		              templateUrl: 'views/none.html'
		          },
			      'detail@': {
					  templateUrl: "views/detail_editor.html",
					  controller: 'EditCtrl'
			      }
		      }
		    })
		.state("items.select.edit.property", {
			url: "propertyAdd",
		    params: {
				selectedItem: undefined,
				item: undefined,
				message: {value: undefined}
		    },
		    onEnter: ['$stateParams', '$state', '$uibModal', function($stateParams, $state, $modal) {
		    	
		    	function goBack(_selectedItem) {
		        	$state.go("items.select.edit", {selectedItem: _selectedItem}, {location:false});
		        }
		    	
		        var modalInstance = $modal.open({
		        	animation: true,
		            templateUrl: "views/propertyEditor.html",
		            resolve: {
		            	selectedItem: function() { 
		            		return $stateParams.selectedItem; 
		            	}
		            },
		            controller: 'PropertyEditorCtrl'
		        });
		        modalInstance.rendered.then(function(){
		        	var $validator = $('.modal-body form').validate({
		        		errorClass: 'has-error',
		        		validClass : 'has-success',
 		        		highlight: function (element, errorClass, validClass) {
				            $(element).closest('.form-group').removeClass('has-success').addClass('has-error');
				            if($validator.numberOfInvalids()>0)
				            	$('.modal-footer .btn.btn-success').addClass('disabled');
				        },
				        unhighlight: function(element, errorClass, validClass) {
				        	$(element).closest('.form-group').removeClass('has-error').addClass('has-success');
				        	if($validator.numberOfInvalids()<1)
					        	$('.modal-footer .btn.btn-success').removeClass('disabled');	
				        },
		 		        success: "has-success"
		        	});
		        	$('.form-control[required]').each(function(i){
		        		$validator.element(this);
		        	});
		        });
		        modalInstance.result.then(goBack, goBack);
		    }]
		  });	
	}])
	.service('Entity', function($resource) {
	  	var res = $resource('../../js/sample_master_detail/md_header.js/:boId', { boId:'@id' }, {
		    save: {
		        method: 'POST',
		        interceptor: {
	                response: function(res) {
	                	var location = res.headers('Location');
	                	if(location){
	                		var id = location.substring(location.lastIndexOf('/')+1);
	                		angular.extend(res.resource, { "mdh_id": id });
                		} else {
                			console.error('Cannot infer id after save operation. HTTP Response Header "Location" is missing: ' + location);
            			}
                        return res.resource;
	                }
	            }, 
	            isArray: false
		    },
		    update: {
		        method: 'PUT'
		    }
		});
		
		res.newObjectTemplate = {
				"mdh_name":"Business Object Name",
				"mdh_description":"Description for business object"
			};
			
		return res;
	})
	.service('Item', function($resource) {
	
	  	var res = $resource('../../js/sample_master_detail/md_item.js/:boId', { boId:'@id' }, {
		    save: {
		        method: 'POST',
		        interceptor: {
	                response: function(res) {
	                	var location = res.headers('Location');
	                	if(location){
	                		var id = location.substring(location.lastIndexOf('/')+1);
	                		angular.extend(res.resource, { "mdi_id": id });
                		} else {
                			console.error('Cannot infer id after save operation. HTTP Response Header "Location" is missing: ' + location);
            			}
                        return res.resource;
	                }
	            }, 
	            isArray: false
		    },
		    update: {
		        method: 'PUT'
		    }
		});
		
		
		res.newObjectTemplate = {
					"mdi_name":"Item",
					"mdi_description":"Description for Item"
				};
				
		return res;
	})	
	.service('masterDataSvc', ['Entity', 'Item',  '$q', function(Entity, Item, $q) {
	
		function createMasterDataTemplateObject(){
			var obj = angular.copy(Entity.newObjectTemplate);
			obj.items = [];
			for(var i = 0; i < 3; i++){
				var item = angular.copy(Item.newObjectTemplate);
				item.mdi_name += ' ' +i;
				obj.items.push(item);
			}
			return obj;
		}
		
		this.masterDataTemplateObject = createMasterDataTemplateObject();
	
		this.query = function(expanded){
			var reqParams = {};
			reqParams.expanded = expanded || true;
			return Entity.query(reqParams).$promise;
		};

		this.create = function(cascaded){
			var reqParams = {};
			reqParams.cascaded = cascaded || true;
			return Entity.save(reqParams, this.masterDataTemplateObject).$promise;
		};
		
		this.update = function(header){
			if(header.items){
				var items = header.items.filter(function(item){
					if(!item.action){
						return false;
					}
					return true;
				});
				var promises = items.map(function(item) {
									var action = item.action;
									delete item.action;
									if(action === 'remove') {
							        	return Item.remove({boId: item.mdi_id}).$promise;
						        	} else {
						        		return Item[action]({boId: item.mdi_id}, item).$promise;
					        		}
						    	});
			}

			promises.unshift(Entity.update({boId: header.mdh_id}, header).$promise);
	    	return $q.all(promises);
		};	
		
		this.remove = function(headerId, cascaded){
			var reqParams = {};
			if(cascaded)
				reqParams.cascaded = cascaded;
			reqParams.boId = headerId;
			return Entity.remove(reqParams).$promise;
		};
		
	}])
	.controller('EmptyCtrl', ['masterDataSvc', '$scope', '$state', '$stateParams', function (masterDataSvc, $scope, $state, $stateParams) {
	
		$scope.createItem = function(){
			masterDataSvc.create()
			.then(function(newItem){
				$stateParams.boId = newItem.mdh_id;
				$stateParams.message = {
					text: 'New Buisness Object successfully created.',
					type: 'alert-success'
				}
				$state.go($state.current, $stateParams, {reload: true});
			}, function(reason){
				console.error(reason);
				// Modal info popup may be triggered here
			});
		};
	
	}])
	.controller('MasterListCtrl', ['masterDataSvc', '$scope', 'orderByFilter', '$state', '$stateParams', '$window', function (masterDataSvc, $scope, orderBy, $state, $stateParams, $window) {
		
		/*Controller invoked upon routing or navigation click events*/
		
		$scope.items = $stateParams.items;
		$scope.selectedItem= $stateParams.selectedItem;
		
		$scope.sortByPropertyName = 'mdh_name';
	    $scope.reverse = false;//ASC
		
	 	$scope.sortBy = function(propertyName) {
		    $scope.reverse = (propertyName !== null && $scope.propertyName === propertyName)
		        ? !$scope.reverse : false;
		    $scope.sortByPropertyName = propertyName;
		    $scope.items = orderBy($scope.items, $scope.sortByPropertyName, $scope.reverse);
		};
		
		$scope.selectItem = function(item){
			if(!$scope.selectedItem && !item || ($scope.selectedItem && $scope.selectedItem.mdh_id === item.mdh_id))//noops
				return;
			if(item){
				$scope.selectedItem = item;// save the selected item
				$state.go('items.select', {
					selectedItem: item,
					boId: item.mdh_id
				});
			}
		}

		function init(){
			var itemId = $state.params.boId;
			if(!$scope.items){
				masterDataSvc.query()
				.then(function(result){
					if(result && result.length>0){
						
						$scope.items = result;//initialize the items to display
						$scope.sortBy($scope.sortByPropertyName);
						
						itemId = itemId || $scope.items[0].mdh_id;					
						var item = findItemById(result, itemId);
						if(item === undefined){
							fireLocationError.apply(this);
							item = result[0];	
						}
						$scope.selectItem.apply($scope, [item]);//set the requested item selected
						
					} else {
						if(!!itemId){
							fireLocationError.apply($scope);
							$state.go('items', $stateParams);
						}
					}
				});	
			}
		}
		
		function findItemById(items, itemId){
			var item;
			for(var i=0; i< items.length; i++){
				if(items[i].mdh_id == itemId ){
					item = items[i];
					break;
				}
			}
			return item;
		}
		
		function fireLocationError(){
			$stateParams.message = {
					text:$window.location.href + " is not valid application path. Check the URL and try again.",
					type: 'alert-danger'
			}
		}
		
		init.apply(this);
		
		$scope.createItem = function(){
			masterDataSvc.create()
			.then(function(newItem){
				$stateParams.boId = newItem.mdh_id;
				$stateParams.message = {
					text: 'New Buisness Object successfully created.',
					type: 'alert-success'
				}
				$state.go($state.current, $stateParams, {reload: true});
			}, function(reason){
				console.error(reason);
				// Modal info popup may be triggered here
			});
		};
		
		$scope.deleteItem = function(itemId){
			masterDataSvc.remove(itemId)
			.then(function(){
				//$state.reload();
				delete $stateParams.boId;
				$stateParams.message = {
						text: 'Buisness Object successfully deleted.',
						type: 'alert-success'
					}
				$state.go($state.current, $stateParams, {reload: true, location:true, inherit: false});
			})
		}
		
	}])
	.controller('DetailsCtrl', ['masterDataSvc', '$scope', '$state', '$stateParams' , function (masterDataSvc, $scope, $state, $stateParams) {
		
		$scope.selectedItem = $stateParams.selectedItem;
				
		$scope.startEdit = function() {
		    $stateParams.itemForEdit = angular.copy($scope.selectedItem);		    
		    $state.go("items.select.edit", $stateParams, {location:false});
		};
		
		$scope.duplicateItem = function() {
			var duplicateItem = angular.copy($scope.selectedItem, {});
			delete duplicateItem.mdh_id;
			masterDataSvc.create(duplicateItem)
				.then(function(newItem){
					$stateParams.boId = newItem.mdh_id;
					$state.go($state.current, $stateParams, {reload: true, location:true, inherit: true});
				});
		};
		
		$scope.deleteItem = function() {
			masterDataSvc.remove($scope.selectedItem.mdh_id)
			.then(function(){
				delete $stateParams.boId;
				$stateParams.message = {
						text: 'Buisness Object successfully deleted.',
						type: 'alert-success'
					}
				$state.go($state.current, $stateParams, {reload: true, location:true, inherit: false});
			});
		};
		
	}])
	.controller('EditCtrl', ['masterDataSvc', '$scope','$state', '$stateParams', function (masterDataSvc, $scope, $state, $stateParams) {
		
		//$scope.selectedItem = $stateParams.itemForEdit;
		$scope.selectedItem = angular.copy($stateParams.itemForEdit);
				
		$scope.openPropertyEditor = function(item){
			$state.go('items.select.edit.property', {
				selectedItem: $scope.selectedItem,
				item: item
			}, {location: false});
		};
		
		$scope.deleteProperty = function(item){
			for(var i=0; i< $scope.selectedItem.items.length; i++){
				if($scope.selectedItem.items[i] === item){
					$scope.selectedItem.items.splice(i,1);
					break;
				}
			}
			$stateParams.itemForEdit.items = $stateParams.itemForEdit.items.map(
				function(currItem){
					if(currItem.mdi_id && currItem.mdi_id === item.mdi_id){
						currItem.action = 'remove';
					}
					return currItem;
				});
		};
		
		$scope.cancelEdit = function() { 
			delete $stateParams.boIdedit;
			delete $stateParams.itemForEdit;
		    $state.go("^", $stateParams);
		};
		
		$scope.saveItem = function() {
		    masterDataSvc.update($stateParams.itemForEdit)
		    	.then(function(item){
					$state.go('items.select', {boId: $scope.selectedItem.mdh_id, selectedItem:$scope.selectedItem});
		    	}, function(err){
		    		console.error('Update Master data failed.' + err);	
		    	});
		};
				
	}])
	.controller('PropertyEditorCtrl', ['$scope', '$stateParams', 'selectedItem', function($scope, $stateParams, selectedItem) {
    	
		var isNewProperty;
		
		function init(){
			isNewProperty = $stateParams.item === undefined ? true : false;
			if(isNewProperty) {
				$scope.item = {
					mdi_name: "Item Name",
					mdi_mdh_id: $stateParams.selectedItem.mdh_id
				}
			} else {
				$scope.item = $stateParams.item;
			}
		}
        
        $scope.cancel = function() {
          $scope.$dismiss($stateParams.selectedItem);
        };

        $scope.ok = function() {
          
	      if(isNewProperty){
	      	$scope.item.action = 'save';
	      	selectedItem.items.push($scope.item);
	      	$stateParams.itemForEdit = $stateParams.selectedItem = selectedItem;
	      } else {
	      	$scope.item.action = 'update';
	    	selectedItem = $stateParams.itemForEdit = $stateParams.selectedItem; 
	      }
          $scope.$close(selectedItem);
        };
        
        init.apply(this);
        
      }])
	.controller('NotificationsCtrl', ['$scope', '$timeout', '$stateParams', function ($scope, $timeout, $stateParams) {
		
		var messageEl = $('.alert');
		$scope.message = $stateParams.message;
		
		$scope.hide = hideMessage;
		
		var timer;
		
		if($scope.message){
			
			$scope.messageTypeClass = $scope.message.type || 'alert-danger';
			
			timer = $timeout(5000)
				.then(function(){
					hideMessage.apply(this);
				});	
		}
		
		function hideMessage(element){
			if($scope.message){
				element = element || messageEl;
				$(element).fadeTo('slow', 0, function(){
					$(element).parent().slideUp('slow', function(){
						$scope.message = undefined;
						$timeout.cancel(timer);
						$scope.$apply();
					});
				});	
			}
		}

		$scope.destroy = function(){
			if(timer){
				$timeout.cancel(timer);
			}
		}
				
	}])
	.run(['editableOptions', function(editableOptions)  {
	  editableOptions.theme = 'bs3'; // bootstrap3 theme. Can be also 'bs2', 'default'
	}]);
	
	</script>

</body>
</html>
